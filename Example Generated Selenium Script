"""
Generated Selenium Test Script
Test Case: TC-001 - Apply Valid Discount Code SAVE15
Generated by: Autonomous QA Agent
"""

from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException, NoSuchElementException
import time

def test_apply_discount_code_save15():
    """
    Test Scenario: Apply valid discount code SAVE15 and verify 15% discount
    Expected Result: Total price reduced by 15%
    Grounded In: product_specs.md
    """
    
    # Setup WebDriver
    driver = webdriver.Chrome()
    driver.maximize_window()
    
    try:
        # Step 1: Navigate to checkout page
        print("Step 1: Opening checkout page...")
        # Update this path to your local checkout.html file
        driver.get("file:///path/to/checkout.html")
        time.sleep(2)
        
        # Step 2: Add item to cart
        print("Step 2: Adding Wireless Headphones to cart...")
        add_to_cart_btn = WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable((By.ID, "add-to-cart-1"))
        )
        add_to_cart_btn.click()
        time.sleep(1)
        
        # Step 3: Verify item added to cart
        print("Step 3: Verifying item in cart...")
        cart_items = driver.find_element(By.ID, "cart-items")
        assert "Wireless Headphones" in cart_items.text, "Item not added to cart"
        
        # Step 4: Get subtotal before discount
        subtotal_element = driver.find_element(By.ID, "subtotal")
        subtotal_text = subtotal_element.text.replace("$", "")
        subtotal_before = float(subtotal_text)
        print(f"Subtotal before discount: ${subtotal_before}")
        
        # Step 5: Enter discount code
        print("Step 5: Entering discount code SAVE15...")
        discount_input = driver.find_element(By.ID, "discount-code")
        discount_input.clear()
        discount_input.send_keys("SAVE15")
        
        # Step 6: Click Apply button
        print("Step 6: Applying discount code...")
        apply_button = driver.find_element(By.ID, "apply-discount")
        apply_button.click()
        time.sleep(1)
        
        # Step 7: Verify success message
        print("Step 7: Verifying discount applied message...")
        discount_message = driver.find_element(By.ID, "discount-message")
        assert "15% discount applied" in discount_message.text, "Discount success message not displayed"
        
        # Step 8: Verify discount amount
        print("Step 8: Verifying discount calculation...")
        discount_element = driver.find_element(By.ID, "discount")
        discount_text = discount_element.text.replace("-$", "")
        discount_amount = float(discount_text)
        expected_discount = round(subtotal_before * 0.15, 2)
        
        assert abs(discount_amount - expected_discount) < 0.01, \
            f"Discount amount incorrect. Expected: ${expected_discount}, Got: ${discount_amount}"
        print(f"✓ Discount correctly calculated: ${discount_amount}")
        
        # Step 9: Verify total price
        print("Step 9: Verifying total price...")
        total_element = driver.find_element(By.ID, "total-price")
        total_text = total_element.text.replace("$", "")
        total_price = float(total_text)
        expected_total = subtotal_before - expected_discount
        
        assert abs(total_price - expected_total) < 0.01, \
            f"Total price incorrect. Expected: ${expected_total}, Got: ${total_price}"
        print(f"✓ Total price correct: ${total_price}")
        
        print("\n✅ TEST PASSED: Discount code SAVE15 applied successfully")
        
    except AssertionError as e:
        print(f"\n❌ TEST FAILED: {str(e)}")
        raise
    
    except TimeoutException as e:
        print(f"\n❌ TEST FAILED: Element not found - {str(e)}")
        raise
    
    except Exception as e:
        print(f"\n❌ TEST FAILED: Unexpected error - {str(e)}")
        raise
    
    finally:
        # Cleanup
        print("\nClosing browser...")
        driver.quit()

def test_apply_invalid_discount_code():
    """
    Test Scenario: Apply invalid discount code
    Expected Result: Error message displayed
    Grounded In: product_specs.md, validation_rules.txt
    """
    
    driver = webdriver.Chrome()
    driver.maximize_window()
    
    try:
        # Navigate to page
        print("Opening checkout page...")
        driver.get("file:///path/to/checkout.html")
        time.sleep(2)
        
        # Add item to cart
        print("Adding item to cart...")
        add_btn = driver.find_element(By.ID, "add-to-cart-1")
        add_btn.click()
        time.sleep(1)
        
        # Enter invalid discount code
        print("Entering invalid discount code...")
        discount_input = driver.find_element(By.ID, "discount-code")
        discount_input.send_keys("INVALID")
        
        # Apply code
        apply_button = driver.find_element(By.ID, "apply-discount")
        apply_button.click()
        time.sleep(1)
        
        # Verify error message
        print("Verifying error message...")
        discount_message = driver.find_element(By.ID, "discount-message")
        assert "Invalid discount code" in discount_message.text, "Error message not displayed"
        
        # Verify no discount applied
        discount_element = driver.find_element(By.ID, "discount")
        assert discount_element.text == "-$0.00", "Discount incorrectly applied"
        
        print("\n✅ TEST PASSED: Invalid code correctly rejected")
        
    except Exception as e:
        print(f"\n❌ TEST FAILED: {str(e)}")
        raise
    
    finally:
        driver.quit()

if __name__ == "__main__":
    print("="*60)
    print("SELENIUM TEST EXECUTION")
    print("="*60)
    
    # Update the file path before running
    print("\n⚠️  IMPORTANT: Update the file path in driver.get() to your local checkout.html\n")
    
    # Run tests
    try:
        test_apply_discount_code_save15()
        print("\n" + "="*60)
        test_apply_invalid_discount_code()
        print("\n" + "="*60)
        print("\n✅ ALL TESTS COMPLETED SUCCESSFULLY")
    except Exception as e:
        print("\n" + "="*60)
        print(f"\n❌ TEST SUITE FAILED: {str(e)}")
    
    print("\n" + "="*60)